name: Build and Deploy (Astro + CNB)

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ æ£€å‡ºæºç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ è®¾ç½® Node ç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3ï¸âƒ£ å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: npm ci

      # 4ï¸âƒ£ æ¸…ç†æ—§æ„å»ºäº§ç‰©
      - name: Clean old build
        run: rm -rf ./dist

      # 5ï¸âƒ£ æ„å»º Astro é™æ€ç«™
      - name: Build project
        run: npm run build

      # 6ï¸âƒ£ éƒ¨ç½²åˆ° GitHub page åˆ†æ”¯ + æ¨é€ CNB ä»“åº“
      - name: Deploy to GitHub Pages & CNB
        env:
          GH_ACTOR: ${{ github.actor }}
          GH_REPO: ${{ github.repository }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CNB_USERNAME: ${{ secrets.CNB_USERNAME }}
          CNB_TOKEN: ${{ secrets.CNB_TOKEN }}
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
          COMMIT_HASH: ${{ github.sha }}
        run: |
          cd ./dist
          git init

          # é…ç½® Git èº«ä»½
          git config user.name "GitHub Action"
          git config user.email "action@github.com"

          # æ„å»ºæäº¤ä¿¡æ¯ï¼ˆåŒ…å«æºç ä¿¡æ¯ï¼‰
          BUILD_TIME=$(date '+%Y-%m-%d %H:%M:%S')
          SHORT_HASH=$(echo "$COMMIT_HASH" | cut -c1-7)
          COMMIT_URL="https://github.com/${GH_REPO}/commit/${COMMIT_HASH}"
          MESSAGE="Deploy from GitHub: \"${COMMIT_MESSAGE}\"
Source commit: ${SHORT_HASH} (${COMMIT_URL})
Built at: ${BUILD_TIME}"

          # æäº¤æ‰€æœ‰æ–‡ä»¶
          git add .
          git commit -m "$MESSAGE"

          echo "ğŸš€ æ¨é€åˆ° GitHub Pages åˆ†æ”¯(page)"
          git push --force --quiet "https://${GH_ACTOR}:${GH_TOKEN}@github.com/${GH_REPO}.git" master:page

          echo "ğŸŒ åŒæ­¥åˆ° CNB ä»“åº“"
          git branch -M main
          git remote add origin "https://${CNB_USERNAME}:${CNB_TOKEN}@cnb.cool/Liiiu/Blog.git"
          git push --force --quiet origin main
