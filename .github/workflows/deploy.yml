name: ğŸš€ Build & Deploy Astro Blog

on:
  push:
    branches:
      - main  # å½“ main åˆ†æ”¯æœ‰æ›´æ–°æ—¶è§¦å‘æ„å»º
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

permissions:
  contents: write  # ğŸ‘ˆ å…è®¸æ¨é€åˆ°ä»“åº“åˆ†æ”¯

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ æ£€å‡ºä»“åº“ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ è®¾ç½® Node ç¯å¢ƒï¼ˆè‡ªåŠ¨ç¼“å­˜ npmï¼‰
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      # 3ï¸âƒ£ å®‰è£…ä¾èµ–ï¼ˆå¸¦è‡ªåŠ¨é‡è¯•ï¼‰
      - name: Install dependencies
        run: |
          echo "ğŸ“¦ æ­£åœ¨å®‰è£…ä¾èµ–..."
          for i in 1 2 3; do
            npm ci && break || (echo "âŒ å®‰è£…å¤±è´¥ï¼Œ${i} ç§’åé‡è¯•ç¬¬ $((i+1)) æ¬¡..." && sleep $((i * 5)))
          done
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      # 4ï¸âƒ£ åˆ é™¤æ—§æ„å»ºäº§ç‰©ï¼ˆé˜²æ­¢æ®‹ç•™ï¼‰
      - name: Clean old build
        run: |
          echo "ğŸ§¹ æ¸…ç†æ—§æ„å»ºç›®å½•..."
          rm -rf dist .astro
          echo "âœ… æ¸…ç†å®Œæˆ"

      # 5ï¸âƒ£ æ„å»º Astro é™æ€æ–‡ä»¶
      - name: Build Astro project
        run: |
          echo "ğŸ—ï¸ æ­£åœ¨æ„å»º Astro é¡¹ç›®..."
          npm run build
          echo "âœ… æ„å»ºå®Œæˆ"

      # 6ï¸âƒ£ éƒ¨ç½²åˆ° page åˆ†æ”¯ï¼ˆGitHub Pages æˆ–é™æ€ä»“åº“ï¼‰
      - name: ğŸ“¦ Deploy to page branch
        run: |
          cd dist
          git init
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          git add .
          COMMIT_MSG=$(printf "%s" "${{ github.event.head_commit.message }}" | tr -d '\n' | tr -d '\r')
          git commit -m "$COMMIT_MSG ==> [$(date +"%Y-%m-%d %H:%M:%S")]"
          git push --force --quiet "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" master:page
          echo "âœ… å·²æ¨é€è‡³ GitHub page åˆ†æ”¯"


      # 7ï¸âƒ£ åŒæ­¥åˆ° CNB ä»“åº“ï¼ˆå¸¦ GitHub commit ä¿¡æ¯ï¼‰
      - name: ğŸŒ Sync to CNB repository
        run: |
          cd dist
          git branch -M main
          git remote add cnb "https://${{ secrets.CNB_USERNAME }}:${{ secrets.CNB_TOKEN }}@cnb.cool/ljxme/lisblogsourcecode.git"
          git fetch cnb || true
          # è·å–å½“å‰ GitHub æäº¤ä¿¡æ¯
          COMMIT_MSG=$(git log -1 --pretty=%s)
          GITHUB_COMMIT_URL="https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
          git commit --allow-empty -m "ğŸ”„ Sync from GitHub: ${COMMIT_MSG}\nğŸ”— ${GITHUB_COMMIT_URL}"
          git push --force --quiet cnb main
          echo "âœ… å·²åŒæ­¥è‡³ CNB ä»“åº“ï¼ˆå¸¦ GitHub æäº¤ä¿¡æ¯ï¼‰"

      # 8ï¸âƒ£ SSH ç™»å½•æœåŠ¡å™¨å¹¶æ‰§è¡Œæ‹‰å–
      - name: ğŸ”§ SSH Deploy to Server
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          passphrase: ${{ secrets.PASSPHRASE }}
          port: ${{ secrets.PORT }}
          script: |
            cd /opt/1panel/www/sites/myblog/index/
            git config --global --add safe.directory "$(pwd)"
            git fetch --all --depth=1
            git reset --hard origin/main
            git pull --depth=1
            echo "âœ… å·²æ‹‰å– page åˆ†æ”¯æœ€æ–°å†…å®¹"

      # 9ï¸âƒ£ åˆ·æ–° DogeCloud CDN ç›®å½•ç¼“å­˜
      # æ–‡æ¡£å‚è€ƒï¼š
      # - è·å–è®¿é—®ä»¤ç‰Œï¼ˆè¯·åœ¨ DogeCloud æ§åˆ¶å°åˆ›å»ºå¹¶ä¿å­˜åˆ°ä»“åº“ Secretsï¼‰ï¼šhttps://docs.dogecloud.com/cdn/api-access-token
      # - æäº¤åˆ·æ–°ä»»åŠ¡æ¥å£ï¼ˆç›®å½•åˆ·æ–° type=dirï¼‰ï¼šhttps://docs.dogecloud.com/cdn/api-refresh-add
      # ä¸ºé¿å…æ¥å£å˜æ›´å¯¼è‡´å¤±è´¥ï¼Œè¿™é‡Œç›´æ¥ä½¿ç”¨é¢„å…ˆåˆ›å»ºçš„è®¿é—®ä»¤ç‰Œ `DOGE_ACCESS_TOKEN`
      - name: â™»ï¸ Refresh CDN Directory
        if: success()
        env:
          # åœ¨ GitHub ä»“åº“è®¾ç½®ä¸­æ·»åŠ  Secretsï¼šDOGE_ACCESS_TOKEN
          DOGE_ACCESS_TOKEN: ${{ secrets.DOGE_ACCESS_TOKEN }}
        run: |
          echo "â™»ï¸ æ­£åœ¨åˆ·æ–° CDN ç›®å½•ç¼“å­˜..."
          if [ -z "$DOGE_ACCESS_TOKEN" ]; then
            echo "âŒ ç¼ºå°‘ DOGE_ACCESS_TOKENï¼Œè¯·åœ¨ä»“åº“ Secrets ä¸­é…ç½®"; exit 1;
          fi

          # åˆ·æ–°ç›®å½•åˆ—è¡¨ï¼šæ­¤å¤„ä»…åˆ·æ–°æ ¹ç›®å½•ï¼Œå¯æŒ‰éœ€è¿½åŠ å­ç›®å½•
          PAYLOAD='{"type":"dir","urls":["https://blog.ljx.icu/"]}'

          # å‘é€åˆ·æ–°è¯·æ±‚åˆ° CDN API
          HTTP_CODE=$(curl -sS -o /tmp/doge_resp.json -w "%{http_code}" \
            -X POST "https://api.dogecloud.com/cdn/refresh/add" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${DOGE_ACCESS_TOKEN}" \
            -d "$PAYLOAD")

          echo "ğŸ” å“åº”çŠ¶æ€ç ï¼š$HTTP_CODE"
          echo "ğŸ“¨ å“åº”å†…å®¹ï¼š"
          cat /tmp/doge_resp.json || true

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "âœ… DogeCloud ç›®å½•åˆ·æ–°ä»»åŠ¡å·²æäº¤ï¼šhttps://blog.ljx.icu/"
          else
            echo "âŒ åˆ·æ–°æ¥å£è¿”å›é 2xxï¼š$HTTP_CODE"; exit 1;
          fi