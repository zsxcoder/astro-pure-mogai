---
import { MediumZoom } from 'astro-pure/advanced'
import { Icon } from 'astro-pure/user'
import BoardLayout from '@/layouts/BoardLayout.astro'
import TalkLoading from '@/components/board/TalkLoading.astro'
import TextBackground from '@/components/custom/TextBackground.astro'

import talks from '../../plugins/talks.js?url'
---

<BoardLayout title='Memo' comment>
  <div style='text-align:center; line-height:1.8; padding:20px 0; position:relative;'>
    <!-- è¯´è¯´çš„èƒŒæ™¯æ–‡å­— -->
    <TextBackground variant='words' />

    <h2 style='font-size:26px; margin-bottom:12px;'>æ¬¢è¿æ¥åˆ° Memo</h2>
    <p style='font-size:16px; color:hsl(var(--foreground));'>è¿™é‡Œæ˜¯æˆ‘çš„ä¸ªäºº Memo ç©ºé—´ ğŸ¤</p>
    <p style='font-size:16px; color:hsl(var(--foreground));'>è®°å½•ç”Ÿæ´»çš„ç‚¹æ»´ âœ”ï¸</p>
    <p style='font-size:16px; color:hsl(var(--foreground));'>åˆ†äº«ç¾å¥½æ—¶å…‰ ğŸ’ª</p>
  </div>

  <div class='mt-4 border-t pt-4'>
    <TalkLoading />
    <div id='talk' class='talk-pending'></div>
  </div>
  <div class='limit-notice'>
    ä»…å±•ç¤ºæœ€è¿‘çš„ Memo
    <a href='https://rin.mcyzsx.top/moments' target='_blank' class='rss-link'>
      <Icon name='rss' class='rss-icon' />
    </a>
  </div>

  <style>
    #talk.talk-pending {
      visibility: hidden;
      min-height: 180px;
    }
    .rss-icon {
      width: 1em;
      height: 1em;
      vertical-align: middle;
      margin-left: 4px;
    }
    .rss-link {
      display: inline-flex;
      align-items: center;
    }
    /* ç¡®ä¿é€‰æ‹©å™¨èƒ½æ­£ç¡®åŒ¹é…åˆ°åˆ—è¡¨å…ƒç´  */
    #talk ul,
    #talk ol {
      margin: 15px 0;
      padding-left: 30px;
      line-height: 1.6;
      list-style: none !important;
    }
    #talk li {
      margin: 8px 0;
      color: #333;
      position: relative;
    }
    /* æ— åºåˆ—è¡¨æ ·å¼ */
    #talk ul li::before {
      content: '';
      position: absolute;
      left: -20px;
      top: 0.7em;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: #6c63ff;
    }
    /* æœ‰åºåˆ—è¡¨æ ·å¼ */
    #talk ol {
      counter-reset: item;
    }
    #talk ol li::before {
      content: counter(item) ".";
      counter-increment: item;
      color: #6c63ff;
      font-weight: 600;
      position: absolute;
      left: -25px;
    }

    .quote-btn {
      color: #666;
      text-decoration: none;
      padding: 5px 10px;
      border-radius: 4px;
      transition: all 0.3s ease;
    }
    .quote-btn:hover {
      color: #6c63ff;
      background-color: rgba(108, 99, 255, 0.1);
    }
    /* SVG å›¾æ ‡æ ·å¼ */
    .icon svg {
      width: 16px;
      height: 16px;
      vertical-align: middle;
      fill: currentColor;
      transition: fill 0.3s ease;
    }
    .quote-btn:hover .icon svg {
      fill: #6c63ff;
    }
  </style>

  <script is:inline>
    // æä¾›ä¸€ä¸ªå¢å¼ºçš„ markdown è§£æå®ç°
    window.marked = {
      setOptions: function() {},
      parse: function(text) {
        // å¤„ç†ä»£ç å— - æ”¯æŒå¸¦æœ‰ç©ºæ ¼çš„ä»£ç å—
        text = text.replace(/```\s*(\w*)\s*\n([\s\S]*?)\n\s*```/g, function(match, lang, code) {
          // ç®€å•çš„ä»£ç é«˜äº®æ¨¡æ‹Ÿ
          return `<pre><code class="language-${lang || 'plaintext'}">${code}</code></pre>`;
        });
        
        // å¤„ç†å…¶ä»– markdown å…ƒç´ 
        return text
          .replace(/(?<!\!)\[(.*?)\]\((.*?)\)/g, function(match, text, url) {
            // æ£€æŸ¥æ˜¯å¦æ˜¯å¤–é“¾
            const exclude = ['blog.ljx.icu', 'localhost', '127.0.0.1', 'b.zsxcoder.top', 'mcy.zsxcoder.top'];
            try {
              const urlObj = new URL(url);
              if (exclude.some(domain => urlObj.hostname === domain || urlObj.hostname.endsWith('.' + domain))) {
                return `<a href="${url}" target="_blank" rel="nofollow noopener">@${text}</a>`;
              } else {
                return `<a href="/safego?url=${encodeURIComponent(url)}" target="_blank" rel="nofollow noopener">@${text}</a>`;
              }
            } catch {
              return `<a href="${url}" target="_blank" rel="nofollow noopener">@${text}</a>`;
            }
          })
          .replace(/!\[(.*?)\]\((.*?)\)/g, '<img src="$2" alt="$1" class="zoomable">')
          .replace(/- \[ \]/g, 'âšª')
          .replace(/- \[x\]/g, 'âš«')
          .replace(/\n/g, '<br>')
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
          .replace(/\*(.*?)\*/g, '<em>$1</em>')
          .replace(/`(.*?)`/g, '<code>$1</code>')
          .replace(/^- (.*?)$/gm, '<li>$1</li>')
          .replace(/(<li>.*?<\/li>)/gs, '<ul>$1</ul>')
          .replace(/^1\. (.*?)$/gm, '<li>$1</li>')
          .replace(/(<li>.*?<\/li>)/gs, '<ol>$1</ol>');
      }
    };
    
    // æä¾› highlight.js æ¨¡æ‹Ÿ
    window.hljs = {
      highlight: function(code, options) {
        return { value: code };
      },
      getLanguage: function() {
        return true;
      }
    };
  </script>
  <script src={talks} no-pjax is:inline></script>

  <MediumZoom selector=".zoomable" />

  <script>
    // è‡ªå®šä¹‰çš„å›¾ç‰‡ç‚¹å‡»å¤„ç†
    function setupImageClickHandlers() {
      const images = document.querySelectorAll('.zoomable');
      images.forEach(img => {
        if (!img.hasAttribute('data-zoom-handler')) {
          img.setAttribute('data-zoom-handler', 'true');
          // ç¡®ä¿å›¾ç‰‡å¯ä»¥è¢«ç‚¹å‡»
          const imgElement = img as HTMLImageElement;
          imgElement.style.cursor = 'zoom-in';
          imgElement.style.pointerEvents = 'auto';
        }
      });
    }

    // ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆ
    window.addEventListener('load', () => {
      // ç­‰å¾… talks åŠ è½½å®Œæˆåè®¾ç½®å›¾ç‰‡ç‚¹å‡»å¤„ç†
      setTimeout(setupImageClickHandlers, 1000);
    });

    // ç›‘å¬åŠ¨æ€å†…å®¹å˜åŒ–ï¼Œä¸ºæ–°æ·»åŠ çš„å›¾ç‰‡è®¾ç½®ç‚¹å‡»å¤„ç†
    const observer = new MutationObserver(() => {
      // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´ç¡®ä¿å›¾ç‰‡å·²åŠ è½½
      setTimeout(setupImageClickHandlers, 500);
    });

    // è§‚å¯Ÿ talk å®¹å™¨çš„å˜åŒ–
    const talkContainer = document.getElementById('talk');
    if (talkContainer) {
      observer.observe(talkContainer, {
        childList: true,
        subtree: true
      });
    }
  </script>
</BoardLayout>
