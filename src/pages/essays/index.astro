---
import { MediumZoom } from 'astro-pure/advanced'
import BoardLayout from '@/layouts/BoardLayout.astro'
import TextBackground from '@/components/custom/TextBackground.astro'
---

<BoardLayout title='Misskey' comment>
  <div style='text-align:center; line-height:1.8; padding:20px 0; position:relative;'>
    <!-- 背景文字 -->
    <TextBackground variant='words' />

    <h2 style='font-size:26px; margin-bottom:12px;'>Essays</h2>
    <p style='font-size:16px; color:hsl(var(--foreground));'>我的Misskey帖子</p>
  </div>

  <div class='mt-4 border-t pt-4'>
    <div id="misskey-embed-container" class='misskey-embed-container'>
      <!-- iframe 将通过 JavaScript 动态创建 -->
    </div>
  </div>

  <style>
    .misskey-embed-container {
      display: flex;
      justify-content: center;
      margin: 20px 0;
    }
    
    @media (max-width: 640px) {
      .misskey-embed-container iframe {
        max-width: 100%;
      }
    }
  </style>

  <script defer src="https://hub.imikufans.com/embed.js" is:inline></script>

  <script>
    // 函数：获取当前主题
    function getCurrentTheme() {
      return document.documentElement.classList.contains('dark') ? 'dark' : 'light'
    }

    // 函数：创建或更新 Misskey 嵌入
    function createMisskeyEmbed() {
      const theme = getCurrentTheme()
      const container = document.getElementById('misskey-embed-container') as HTMLElement | null
      
      if (container) {
        // 清空容器
        container.innerHTML = ''
        
        // 创建新的 iframe 元素
        const iframe = document.createElement('iframe')
        iframe.src = `https://hub.imikufans.com/embed/user-timeline/ahe8iuwty5zv05sz?header=false&maxHeight=700&border=false`
        iframe.setAttribute('data-misskey-embed-id', 'v1_aheqyqlvbz')
        iframe.loading = 'lazy'
        iframe.referrerPolicy = 'strict-origin-when-cross-origin'
        iframe.style.border = 'none'
        iframe.style.width = '100%'
        iframe.style.maxWidth = '500px'
        iframe.style.height = '300px'
        iframe.style.colorScheme = theme === 'dark' ? 'dark' : 'light'
        
        // 添加到容器
        container.appendChild(iframe)
      }
    }

    // 观察主题变化
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
          // 主题变化时重新创建嵌入
          createMisskeyEmbed()
        }
      })
    })

    // 开始观察
    observer.observe(document.documentElement, { attributes: true })

    // 页面加载完成后，创建初始嵌入
    window.addEventListener('DOMContentLoaded', () => {
      // 延迟一点时间确保 DOM 已准备好
      setTimeout(createMisskeyEmbed, 100)
    })

    // 清理
    document.addEventListener('astro:page-unload', () => {
      observer.disconnect()
    })
  </script>

  <MediumZoom />
</BoardLayout>