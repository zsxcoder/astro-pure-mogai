---
import { cn } from 'astro-pure/utils'

/**
 * SteamGameCard Component
 * Fetches and displays Steam game information for a given user ID.
 * Uses server-side fetching to retrieve the games page and extract data.
 */
interface Props {
  id: string
  limit?: number
  class?: string
}

const { id, limit = 6, class: className, ...props } = Astro.props

interface Game {
  appid: number
  name: string
  logo: string
  friendlyURL?: string
  hours_forever?: string
  last_played?: number
}

let games: Game[] = []
let error = null
let avatar = ''
let personaName = ''

try {
  // Fetch games page
  const response = await fetch(`https://steamcommunity.com/id/${id}/games?tab=recent`, {
    headers: {
      'User-Agent':
        'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
    }
  })

  if (!response.ok) {
    throw new Error(`Failed to fetch Steam data: ${response.statusText}`)
  }

  const html = await response.text()

  // Extract rgGames
  const gamesMatch = html.match(/var rgGames = (\[.*?\]);/)
  if (gamesMatch) {
    games = JSON.parse(gamesMatch[1])
  } else {
    // Fallback: try to find the player profile if rgGames is missing (e.g. private profile)
    console.warn('Steam games data (rgGames) not found in response.')
  }

  // Extract Profile Info (optional)
  const avatarMatch = html.match(/<div class="playerAvatarAutoSizeInner">[\s\S]*?<img src="(.*?)">/)
  if (avatarMatch) {
    avatar = avatarMatch[1]
  }

  const nameMatch = html.match(/<span class="actual_persona_name">(.*?)<\/span>/)
  if (nameMatch) {
    personaName = nameMatch[1]
  }
} catch (e) {
  console.error('Steam Fetch Error:', e)
  error = e
}

// Filter and sort games if needed
// recent tab usually returns recently played.
if (games.length > 0) {
  // Ensure we have limits
  games = games.slice(0, limit)
}
---

<div
  class={cn('not-prose flex flex-col rounded-xl border py-3 px-3 gap-y-3 sm:gap-y-4', className)}
  {...props}
>
  <div class='m-0 px-2 flex items-center gap-2'>
    {avatar && <img src={avatar} alt={personaName} class='size-6 rounded-full' />}
    <div class='text-lg font-medium leading-none'>
      {personaName || id} 的 Steam 游戏
    </div>
    <a
      href={`https://steamcommunity.com/id/${id}/games`}
      target='_blank'
      class='ml-auto text-xs text-muted-foreground hover:text-primary transition-colors'
    >
      更多 &rarr;
    </a>
  </div>

  {
    error ? (
      <div class='text-center py-4 text-sm text-muted-foreground'>
        <p>无法获取 Steam 数据 (可能由于网络原因)</p>
      </div>
    ) : games.length === 0 ? (
      <div class='text-center py-4 text-sm text-muted-foreground'>
        <p>暂无游戏数据或个人资料私密</p>
      </div>
    ) : (
      <div class='grid grid-cols-1 gap-x-2 gap-y-2 sm:grid-cols-2'>
        {games.map((game) => (
          <a
            href={`https://store.steampowered.com/app/${game.appid}`}
            target='_blank'
            rel='noopener noreferrer'
            class='group relative text-sm leading-normal no-underline'
          >
            <div class='flex items-center gap-x-3 rounded-lg border border-transparent px-1.5 py-1 transition-colors hover:border-border hover:bg-muted'>
              <div class='relative h-10 w-20 flex-shrink-0 overflow-hidden rounded-md bg-muted'>
                <img
                  src={`https://steamcdn-a.akamaihd.net/steam/apps/${game.appid}/header.jpg`}
                  alt={game.name}
                  class='h-full w-full object-cover transition-transform duration-300 group-hover:scale-105'
                  loading='lazy'
                />
              </div>
              <div class='z-20 flex flex-col min-w-0'>
                <div class='font-medium text-foreground truncate' title={game.name}>
                  {game.name}
                </div>
                {game.hours_forever && (
                  <div class='font-normal text-muted-foreground text-xs'>{game.hours_forever}</div>
                )}
              </div>
            </div>
          </a>
        ))}
      </div>
    )
  }
</div>
