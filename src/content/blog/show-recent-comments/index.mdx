---
title: 'é€šè¿‡Waline APIè·å–æœ€æ–°è¯„è®ºå¹¶æ˜¾ç¤º'
description: 'åŸºäºwalineå®˜æ–¹æ–‡æ¡£æ¥å£çš„å°è¿ç”¨'
publishDate: '2025-11-02'
heroImage: { src: './cover.jpg', alt: 'an image targetting my article' }
tags:
  - ä¸»é¢˜ç¾åŒ–
  - Waline
  - TypeScript
  - CSS
  - Astro
comment: true
language: 'ä¸­æ–‡'
summary: 'æ–‡ç« ä»‹ç»äº†å¦‚ä½•é€šè¿‡WalineAPIè·å–ç½‘ç«™æœ€æ–°è¯„è®ºæ•°æ®å¹¶å±•ç¤ºåœ¨ç»„ä»¶ä¸­ï¼Œé¦–å…ˆï¼Œæµè§ˆäº†Walineçš„å®˜æ–¹æ¥å£æ–‡æ¡£ï¼Œå‘ç°å¯ä»¥é€šè¿‡APIè¿”å›æœ€æ–°è¯„è®ºæ•°æ®ï¼Œç„¶åï¼Œç¼–å†™äº†ä¸€ä¸ªé€‚ç”¨äºå½“å‰ä¸»é¢˜çš„è¯„è®ºå±•ç¤ºç»„ä»¶ï¼Œå¹¶åœ¨GitHubä¸Šå¼€æºäº†ä»£ç ç‰‡æ®µï¼Œæœ€åï¼Œæ·»åŠ äº†å¿…è¦çš„æ–‡ä»¶å†…å®¹ï¼ŒåŒ…æ‹¬å¯¼å…¥RecentCommentsç»„ä»¶å’Œå®šä¹‰ç»„ä»¶ç»“æ„ã€‚'
---

## èµ·å› 

æµè§ˆ [Walineçš„å®˜æ–¹æ¥å£æ–‡æ¡£](https://waline.js.org/reference/server/api.html) æ—¶å‘ç°é€šè¿‡ `/api/comment?type=recent` æ¥å£èƒ½è¿”å›ç½‘ç«™æœ€æ–°è¯„è®ºæ•°æ®ï¼Œäºæ˜¯â€œå¥´å½¹â€AIç»™æˆ‘å†™äº†ä¸€ä¸ªé€‚ç”¨å½“å‰ä¸»é¢˜çš„è¯„è®ºå±•ç¤ºç»„ä»¶ï¼Œç›®å‰æ²¡å‡ºå•¥å¤§å·®é”™ğŸ¤£

## å¼•å…¥

ä»£ç ç‰‡æ®µGistå¼€æºåœ°å€ï¼š[Recent Comments for Astro-Theme-Pure](https://gist.github.com/ljxme/e08c5d42abc5e5aa3fdda2d16aa5a60a)

### recentcomment.tsæ–‡ä»¶

åœ¨ `src/plugins` ç›®å½•ä¸‹æ–°å»º `recentcomment.ts` æ–‡ä»¶å¹¶å¡«å…¥ä»¥ä¸‹å†…å®¹ï¼ˆ**æ³¨æ„éœ€è¦æ›¿æ¢çš„éƒ¨åˆ†**ï¼‰ï¼š

```ts title="recentcomment.ts"
/**
 * è·å–å¹¶å¤„ç†æœ€æ–°è¯„è®ºæ•°æ®
 * é€šè¿‡Waline APIè·å–æœ€æ–°è¯„è®ºå¹¶æ ¼å¼åŒ–æ˜¾ç¤º
 */

// å®šä¹‰è¯„è®ºæ•°æ®æ¥å£
interface WalineComment {
  nick: string // è¯„è®ºè€…æ˜µç§°
  comment: string // è¯„è®ºå†…å®¹
  url: string // è¯„è®ºé¡µé¢URL
  avatar: string // å¤´åƒURL
  time: number // è¯„è®ºæ—¶é—´æˆ³
  like?: number // ç‚¹èµæ•°
  addr?: string // åœ°å€
}

// å®šä¹‰APIå“åº”æ¥å£
interface WalineResponse {
  data: WalineComment[]
}

/**
 * è·å–æœ€æ–°è¯„è®ºæ•°æ®
 * @param limit è·å–è¯„è®ºæ•°é‡é™åˆ¶
 * @returns æ ¼å¼åŒ–åçš„è¯„è®ºæ•°æ®
 */
export async function fetchRecentComments(limit: number = 5): Promise<WalineComment[]> {
  try {
    // <Walineåç«¯åœ°å€> è¯·å°†è¯¥éƒ¨åˆ†æ›¿æ¢ä¸ºä½ è‡ªå·±æ­å»ºçš„Walineåç«¯æœåŠ¡åœ°å€ <!-- [!code highlight:2] -->
    const response = await fetch('https://<Walineåç«¯åœ°å€>/api/comment?type=recent')
    if (!response.ok) {
      throw new Error(`è·å–è¯„è®ºå¤±è´¥: ${response.status}`)
    }

    const data: WalineResponse = await response.json()
    return data.data.slice(0, limit)
  } catch (error) {
    console.error('è·å–æœ€æ–°è¯„è®ºå‡ºé”™:', error)
    return []
  }
}

/**
 * æ ¼å¼åŒ–è¯„è®ºæ—¶é—´
 * @param timestamp æ—¶é—´æˆ³
 * @returns æ ¼å¼åŒ–åçš„æ—¶é—´å­—ç¬¦ä¸²
 */
export function formatCommentTime(timestamp: number): string {
  const date = new Date(timestamp)
  const now = new Date()
  const diff = now.getTime() - date.getTime()

  // ä¸€åˆ†é’Ÿå†…
  if (diff < 60 * 1000) {
    return 'åˆšåˆš'
  }

  // ä¸€å°æ—¶å†…
  if (diff < 60 * 60 * 1000) {
    return `${Math.floor(diff / (60 * 1000))}åˆ†é’Ÿå‰`
  }

  // ä¸€å¤©å†…
  if (diff < 24 * 60 * 60 * 1000) {
    return `${Math.floor(diff / (60 * 60 * 1000))}å°æ—¶å‰`
  }

  // ä¸€å‘¨å†…
  if (diff < 7 * 24 * 60 * 60 * 1000) {
    return `${Math.floor(diff / (24 * 60 * 60 * 1000))}å¤©å‰`
  }

  // å…¶ä»–æƒ…å†µæ˜¾ç¤ºå…·ä½“æ—¥æœŸ
  return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`
}

/**
 * æ¸…ç†HTMLæ ‡ç­¾
 * @param html HTMLå­—ç¬¦ä¸²
 * @returns æ¸…ç†åçš„çº¯æ–‡æœ¬
 */
export function stripHtml(html: string): string {
  // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ›¿ä»£DOMæ“ä½œï¼Œå¯åœ¨æœåŠ¡å™¨ç«¯è¿è¡Œ
  return html.replace(/<[^>]*>/g, '')
}

/**
 * æˆªæ–­æ–‡æœ¬
 * @param text åŸå§‹æ–‡æœ¬
 * @param length æœ€å¤§é•¿åº¦
 * @returns æˆªæ–­åçš„æ–‡æœ¬
 */
export function truncateText(text: string, length: number = 100): string {
  if (text.length <= length) return text
  return text.substring(0, length) + '...'
}
```

### rc.cssæ–‡ä»¶

åœ¨ `src/assets/styles` ç›®å½•ä¸‹æ–°å»º `rc.css` æ–‡ä»¶å¹¶å¡«å…¥ä»¥ä¸‹å†…å®¹ï¼š

```css title="rc.css"
/* æœ€æ–°è¯„è®ºç»„ä»¶æ ·å¼ */
.recent-comments {
  background-color: hsl(var(--background) / var(--un-bg-opacity, 1));
  border: 1px solid hsl(var(--border) / var(--un-border-opacity, 1));
  border-radius: var(--radius);
  padding: 1rem;
  margin-bottom: 1.5rem;
  margin-top: 0;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}

.recent-comments-title {
  font-size: 1.2rem;
  font-weight: 500;
  margin-bottom: 1rem;
  color: hsl(var(--foreground) / var(--un-text-opacity, 1));
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.recent-comments-title svg {
  width: 1.2rem;
  height: 1.2rem;
}

.comment-list {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.comment-item {
  display: flex;
  gap: 0.75rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid hsl(var(--border) / 0.5);
}

.comment-item:last-child {
  border-bottom: none;
  padding-bottom: 0;
}

.comment-avatar {
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  overflow: hidden;
  flex-shrink: 0;
}

.comment-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.comment-content {
  flex: 1;
  min-width: 0;
}

.comment-meta {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.25rem;
}

.comment-author {
  font-weight: 500;
  color: hsl(var(--foreground) / var(--un-text-opacity, 1));
  font-size: 0.9rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.comment-time {
  font-size: 0.8rem;
  color: hsl(var(--muted-foreground) / var(--un-text-opacity, 1));
}

.comment-text {
  font-size: 0.9rem;
  color: hsl(var(--muted-foreground) / var(--un-text-opacity, 1));
  line-height: 1.5;
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  word-break: break-word;
}

.comment-link {
  display: block;
  font-size: 0.8rem;
  color: hsl(var(--primary) / var(--un-text-opacity, 1));
  margin-top: 0.25rem;
  text-decoration: none;
  transition: opacity 0.2s;
}

.comment-link:hover {
  opacity: 0.8;
}

.comment-empty {
  text-align: center;
  padding: 1rem 0;
  color: hsl(var(--muted-foreground) / var(--un-text-opacity, 1));
  font-size: 0.9rem;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .comment-avatar {
    width: 2rem;
    height: 2rem;
  }

  .comment-author {
    font-size: 0.85rem;
  }

  .comment-time {
    font-size: 0.75rem;
  }

  .comment-text {
    font-size: 0.85rem;
    -webkit-line-clamp: 2;
  }
}
```

### RecentComments.astroæ–‡ä»¶

3. åœ¨ç›®å½•ä¸‹ `src/components` ç›®å½•ä¸‹æ–°å»º `RecentComments.astro` æ–‡ä»¶å¹¶å¡«å…¥ä»¥ä¸‹å†…å®¹ï¼š

```astro title="RecentComments.astro"
---
import { Icon } from 'astro-pure/user'
import {
  fetchRecentComments,
  formatCommentTime,
  stripHtml,
  truncateText
} from '@/plugins/recentcomment'

// è·å–æœ€æ–°è¯„è®ºæ•°æ®
const comments = await fetchRecentComments(5)
---

<div class='recent-comments'>
  <div class='recent-comments-title'>
    <Icon name='list' />
    <span>æœ€æ–°è¯„è®º</span>
  </div>

  <div class='comment-list'>
    {
      comments.length > 0 ? (
        comments.map((comment) => (
          <div class='comment-item'>
            <div class='comment-avatar'>
              <img src={comment.avatar} alt={comment.nick} loading='lazy' />
            </div>
            <div class='comment-content'>
              <div class='comment-meta'>
                <span class='comment-author'>{comment.nick}</span>
                <span class='comment-time'>{formatCommentTime(comment.time)}</span>
              </div>
              <div class='comment-text' set:html={truncateText(stripHtml(comment.comment), 100)} />
              <a href={comment.url ? comment.url.replace(/\/$/, '') : '#'} class='comment-link'>
                æŸ¥çœ‹è¯¦æƒ… â†’
              </a>
            </div>
          </div>
        ))
      ) : (
        <div class='comment-empty'>æš‚æ— è¯„è®ºæ•°æ®</div>
      )
    }
  </div>
</div>

<script>
  // å®¢æˆ·ç«¯æ¸…ç†HTMLæ ‡ç­¾
  document.addEventListener('astro:page-load', () => {
    const commentTexts = document.querySelectorAll('.comment-text')
    commentTexts.forEach((element) => {
      // ç¡®ä¿é“¾æ¥åœ¨æ–°çª—å£æ‰“å¼€
      const links = element.querySelectorAll('a')
      links.forEach((link) => {
        link.setAttribute('target', '_blank')
        link.setAttribute('rel', 'noopener noreferrer')
      })
    })
  })
</script>

<style is:global>
  @import '@/assets/styles/rc.css';
</style>
```

## ä½¿ç”¨

### åœ¨Pureä¸»é¢˜ä¸»é¡µä¸­ä½¿ç”¨

å¢æ·» `src/pages/index.astro` æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š

```astro title="index.astro"
---
import RecentComments from '@/components/RecentComments.astro' //å¼•å…¥ç»„ä»¶ # [!code ++]
---

<PageLayout meta={{ title: 'é¦–é¡µ' }} highlightColor='#FFF8DC'>
  <main class='flex w-full flex-col items-center'>
    <div
      id='content'
      class='animate flex flex-col md:flex-row gap-y-10 md:gap-x-6 md:w-4/5 lg:w-5/6'
    >
      <!--çœç•¥ä¸­é—´ä»£ç -->
      <div class='md:w-1/3 md:mt-0'>
        # [!code ++]
        <RecentComments /> # [!code ++]
      </div> # [!code ++]
      <!--çœç•¥æ­¤åä»£ç -->
    </div>
    <Quote class='mt-12' />
  </main>
</PageLayout>
```

### æœ€å°åŒ–ä½¿ç”¨

```astro
---
import RecentComments from '@/components/RecentComments.astro'
---

<RecentComments />
```
