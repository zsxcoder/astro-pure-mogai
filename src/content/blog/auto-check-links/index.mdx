---
title: è‡ªåŠ¨åŒ–å‹é“¾æ£€æµ‹
description: åˆ©ç”¨ GitHub Actions è¿›è¡Œè‡ªåŠ¨å‹é“¾æ£€æ´»
publishDate: 2025-12-31
tags:
  - ä¸»é¢˜é­”æ”¹
  - typeScript
  - github
  - css
summary: >-
  æ–‡ç« ä»‹ç»äº†è‡ªåŠ¨åŒ–å‹é“¾æ£€æµ‹çš„æµç¨‹ï¼ŒåŒ…æ‹¬åˆ›å»ºcheck-links.tsæ–‡ä»¶ã€é…ç½®ç›¸å…³å‚æ•°ä»¥åŠå®ç°å‹é“¾çŠ¶æ€æ£€æµ‹ã€‚åŒæ—¶ï¼Œè¿˜æåˆ°äº†GitHub
  Actionsä¸­çš„Friend Links CheckåŠŸèƒ½ï¼Œå¯ä»¥æ¯å¤©å›ºå®šæ—¶é—´è¿è¡Œæˆ–åœ¨links.jsonæ›´æ–°æ—¶è‡ªåŠ¨è¿è¡Œã€‚
---

##  å‰è¨€

æœ€è¿‘æ”¾å‡é—²ç€æ²¡äº‹å¹²ï¼ŒæŠ½äº†ç‚¹æ—¶é—´å®Œå–„äº†ä¸‹å‹é“¾æ–¹é¢çš„æ£€æµ‹ï¼Œç°åœ¨å¯ä»¥æ›´æ¸…æ¥šåœ°çœ‹åˆ°æœ‹å‹ä»¬çš„ [ç«™ç‚¹çŠ¶æ€](/links) äº†ï¼ä¸è¿‡è¿˜æœ‰ç‚¹ä¸è¶³, åªæ£€æµ‹äº†çŠ¶æ€ï¼Œå¹¶æ²¡æœ‰åšåˆ°é€šçŸ¥æ–¹é¢çš„åŠŸèƒ½ï¼Œå®ç°æ–¹å¼ä¹Ÿæ¯”è¾ƒæ½¦è‰ï¼Œåç»­ä¼šä¸æ–­å®Œå–„æ»´ï¼

### æµç¨‹

ç®€å•ç”»äº†ä¸ªè¿è¡Œçš„æµç¨‹å›¾ğŸ˜‹

![check-links](https://tc.ljx.icu/file/3l5dWlk3.svg "ç®€æ˜“æµç¨‹è‰å›¾")

## å¼•å…¥

### check-links.tsæ–‡ä»¶

åˆ›å»º `scripts/check-links.ts` æ–‡ä»¶å¹¶å†™å…¥ä»¥ä¸‹å†…å®¹ï¼š

```ts title="check-links.ts"
import fs from 'node:fs/promises'
import path from 'node:path'
import pLimit from 'p-limit'

import links from '../public/links.json' with { type: 'json' }

const DATA_PATH = path.resolve('public/links.json')
const CHECK_TIMEOUT = 15000
const PLimit_NUM = 5
const MAX_RETRIES = 3
const RETRY_DELAY = 1000
const SKIP_CHECK_NAMES = ['']

interface FriendLink {
  name: string
  link: string
  responseTime?: number
}

interface FriendGroup {
  id_name: 'cf-links' | 'inactive-links' | 'special-links'
  link_list: FriendLink[]
}

interface FriendLinksConfig {
  friends: FriendGroup[]
}

type LinkStatus = 'ok' | 'timeout' | 'error'

interface LinkCheckResult {
  name: string
  link: string
  status?: LinkStatus
  httpStatus?: number
  responseTime?: number
  reason?: string
}

async function fetchLink(url: string) {
  const controller = new AbortController()
  const timer = setTimeout(() => controller.abort(), CHECK_TIMEOUT)

  try {
    const start = Date.now()
    const res = await fetch(url, {
      method: 'HEAD',
      signal: controller.signal,
      redirect: 'follow',
      cache: 'no-store',
      headers: { 'User-Agent': 'Mozilla/5.0 FriendLinkChecker/1.0' }
    })
    const time = Date.now() - start

    return {
      ok: res.ok,
      status: res.status,
      time
    }
  } finally {
    clearTimeout(timer)
  }
}

const ENV_SKIP_NAMES = process.env.SKIP_CHECK_NAMES?.split(',') || []
const SKIP_NAMES = new Set(
  SKIP_CHECK_NAMES.concat(ENV_SKIP_NAMES)
    .map((s) => s.trim())
    .filter(Boolean)
)
async function checkLink(link: FriendLink): Promise<LinkCheckResult> {
  if (SKIP_NAMES.has(link.name)) {
    console.log(`[Check-Links] ${link.name} (${link.link}) skipped ğŸ§¹`)
    return {
      name: link.name,
      link: link.link,
      status: 'ok',
      reason: 'skip_check',
      responseTime: 0
    }
  }

  let lastError: Error | null = null

  for (let i = 0; i < MAX_RETRIES; i++) {
    try {
      const res = await fetchLink(link.link)
      console.log(`[Check-Links] ${link.name} responded in ${res.time}ms âœ¨`)

      if (!res.ok) throw new Error(`HTTP ${res.status}`)

      return {
        name: link.name,
        link: link.link,
        status: 'ok',
        httpStatus: res.status,
        responseTime: res.time
      }
    } catch (e: unknown) {
      lastError = e instanceof Error ? e : new Error(String(e))
      if (i < MAX_RETRIES - 1) {
        const delay = RETRY_DELAY * 2 ** i + Math.floor(Math.random() * 100)
        console.warn(
          `[Check-Links] Retry attempt (${i + 1}/${MAX_RETRIES}) for ${link.name} after ${delay}ms due to: ${lastError.message} ğŸ˜­`
        )
        await new Promise((resolve) => setTimeout(resolve, delay))
      }
    }
  }

  return {
    name: link.name,
    link: link.link,
    status: lastError?.name === 'AbortError' ? 'timeout' : 'error',
    reason: lastError?.message,
    responseTime: 0
  }
}

async function main() {
  console.log('[Check-Links] Start checking friend links... â¤ï¸')

  const config = links as FriendLinksConfig
  const limit = pLimit(PLimit_NUM)

  const tasks = config.friends
    .filter((g) => g.id_name === 'cf-links')
    .flatMap((group) => group.link_list.map((link) => limit(() => checkLink(link))))

  const results = await Promise.allSettled(tasks)

  const linkMap = new Map<string, LinkCheckResult>()

  for (const r of results) {
    if (r.status === 'fulfilled') {
      linkMap.set(r.value.link, r.value)
    } else {
      console.error(`[Check-Links] Unexpected error (${r.reason}) ğŸ¤”`)
    }
  }
  for (const group of config.friends) {
    for (const link of group.link_list) {
      const res = linkMap.get(link.link)
      if (res) {
        link.responseTime = res.responseTime ?? 0
      }
    }
  }

  await fs.writeFile(DATA_PATH, JSON.stringify(config, null, 2))

  const failed = Array.from(linkMap.values()).filter((r) => r.status !== 'ok')
  if (failed.length > 0) {
    console.error(
      `[Check-Links] Friend link check failed (${failed.length} inactive links checked) ğŸ˜¡:`
    )
    for (const f of failed) {
      console.error(
        `[Check-Links] - ${f.name} (${f.link}) => ${f.status}`,
        f.reason ? ` | ${f.reason}` : ''
      )
    }
    process.exit(1)
  }

  console.log(
    `[Check-Links] All links are healthy and responseTime updated (${results.length} links checked) ğŸ˜‹`
  )
}

main()

```

**ç›¸å…³é…ç½®è¯´æ˜**

| é…ç½®é¡¹             | é»˜è®¤å€¼  |  è¯´æ˜                                                   |
| :----------------: | :-----:  | :----------------------------------------------------: |
| `CHECK_TIMEOUT`    | `15000`  | å•ä¸ªé“¾æ¥æ£€æµ‹çš„è¶…æ—¶æ—¶é—´ï¼Œè¶…è¿‡è¯¥æ—¶é—´è§†ä¸ºè¯·æ±‚å¤±è´¥         |
| `PLimit_NUM`       | `5`      | å¹¶å‘æ£€æµ‹çš„æœ€å¤§æ•°é‡ï¼Œç”¨äºé™åˆ¶åŒæ—¶è¿›è¡Œçš„è¯·æ±‚æ•°           |
| `MAX_RETRIES`      | `3`      | é“¾æ¥æ£€æµ‹å¤±è´¥åçš„æœ€å¤§é‡è¯•æ¬¡æ•°                           |
| `RETRY_DELAY`      | `1000`    | æ¯æ¬¡é‡è¯•ä¹‹é—´çš„ç­‰å¾…æ—¶é—´                                 |
| `SKIP_CHECK_NAMES` | `['']`    | è·³è¿‡æ£€æµ‹çš„ç«™ç‚¹åç§°åˆ—è¡¨ï¼Œåç§°åŒ¹é…æ—¶å°†ä¸ä¼šè¿›è¡Œå¯ç”¨æ€§æ£€æµ‹ |

è·³è¿‡æ£€æµ‹çš„ç«™ç‚¹åç§°åˆ—è¡¨ä¹Ÿæ”¯æŒåœ¨åç»­çš„ GitHub Actions å˜é‡ä¸­è¿›è¡Œæ§åˆ¶ï¼ˆå¯åŒæ—¶å­˜åœ¨ï¼‰[å¡«å†™æ ¼å¼ï¼šå‹é“¾åç§°1,å‹é“¾åç§°2]

### check-links.ymlæ–‡ä»¶

åˆ›å»º `.github/workflows/check-links.yml` å¹¶å†™å…¥ä»¥ä¸‹å†…å®¹ï¼š
```yml title="check-links.yml"
name: ğŸ”— Friend Links Check

on:
  push:
    branches:
      - main
    paths:
      - 'public/links.json'
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:

jobs:
  check-links-and-update:
    name: Link Check & Upload
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps
        run: npm install p-limit tsx

      - name: Run link check
        run: npx tsx scripts/check-links.ts
```

åç»­çš„æ­¥éª¤æˆ‘é‡‡ç”¨ä¸Šä¼ è‡³å­˜å‚¨æ¡¶çš„æ–¹å¼è€Œégitæäº¤å›ä»“åº“ï¼Œä¸»è¦æ˜¯æ€•æ±¡æŸ“gitçš„æäº¤ä¿¡æ¯ï¼ˆè€Œä¸”è¿è¡Œä¸€æ¬¡è„šæœ¬ï¼Œæœ¬åœ°ä»“åº“å°±è¦å†æ‹‰å–ä¸€æ¬¡æ„Ÿè§‰æŒºéº»çƒ¦ï¼‰ï¼Œä½ ä¹Ÿå¯ä»¥æ”¹æˆä½ æƒ³è¦çš„æ–¹å¼ï¼Œæˆ–è€…æŠŠgitæäº¤è¿™éƒ¨åˆ†ç›´æ¥å†™è¿›å‰é¢çš„ `check-links.ts` è„šæœ¬

```yml title="check-links.yml"
      - name: Upload link.json to bucket
        run: |
          aws s3api put-object \
            --bucket ${{ secrets.BITIFUL_BUCKET_NAME }} \
            --key link.json \
            --body public/links.json \
            --endpoint-url https://${{ secrets.BITIFUL_S3_ENDPOINT }} \
            --region ${{ secrets.BITIFUL_REGION }}
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.BITIFUL_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.BITIFUL_SECRET_ACCESS_KEY }}
```

è¿™é‡Œçš„å­˜å‚¨æ¡¶æˆ‘é€‰æ‹©çš„æ˜¯ [ç¼¤çº·äº‘](https://www.bitiful.com/) ï¼Œç›¸å…³å˜é‡é…ç½®åœ¨ GitHub Actions çš„ secrets é‡Œï¼Œå˜é‡è·å–åœ¨ [æ§åˆ¶å°é¡µé¢](https://console.bitiful.com)ï¼Œå¯¹åº”å¦‚ä¸‹

| Secrets åç§°                  | å«ä¹‰è¯´æ˜                              | ç¤ºä¾‹å€¼                  |
| :-------------------------: | :-------------------------------: | :----------------------: |
| `BITIFUL_BUCKET_NAME`       | ç¼¤çº·äº‘å¯¹è±¡å­˜å‚¨æ¡¶åç§°ï¼ˆBucket Nameï¼‰           | `my-static-assets`       |
| `BITIFUL_S3_ENDPOINT`       | ç¼¤çº·äº‘ S3 å…¼å®¹ API Endpoint            | `https://s3.bitiful.net` |
| `BITIFUL_REGION`            | å­˜å‚¨æ¡¶æ‰€åœ¨åŒºåŸŸï¼ˆRegionï¼‰                   | `cn-east-1`              |
| `BITIFUL_ACCESS_KEY_ID`     | ç¼¤çº·äº‘è®¿é—®å¯†é’¥ IDï¼ˆAccess Key IDï¼‰         | `AKIAxxxxxxxxxxxx`       |
| `BITIFUL_SECRET_ACCESS_KEY` | ç¼¤çº·äº‘è®¿é—®å¯†é’¥ Secretï¼ˆSecret Access Keyï¼‰ | `xxxxxxxxxxxxxxxxxxxx`   |


ç”±äºæˆ‘ç»™åšå®¢è¿›è¡Œäº†å›½å†…å¤–åˆ†æµï¼Œå›½å¤–æ‰˜ç®¡åˆ°äº†CFä¸Šï¼ŒåŠ ä¸Šå‰é¢å¹¶æ²¡æœ‰é€‰æ‹©gitæäº¤çš„æ–¹å¼ï¼Œæ‰€ä»¥æ£€æµ‹å®Œå‹é“¾åéœ€è¦è®©å…¶é‡æ–°æ„å»ºä¸€éï¼Œä»¥åŒæ­¥è¿›åº¦ã€‚

```yml title="check-links.yml"
  trigger-pages-build:
    name: Trigger Cloudflare Pages build
    needs: check-links-and-update
    runs-on: ubuntu-latest

    if: ${{ needs.check-links-and-update.result == 'success' }}

    steps:
      - name: Update Cloudflare Pages
        run: |
            curl -X POST \
            "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CF_ACCOUNT_ID }}/pages/projects/${{ secrets.CF_PROJECT_NAME }}/deployments" \
            -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{}'
```

æ‰€éœ€å˜é‡å¯¹åº”å¦‚ä¸‹ï¼š

| Secrets åç§°        | å«ä¹‰è¯´æ˜                                    | ç¤ºä¾‹å€¼                   |
| :---------------: | :-------------------------------------: | :-------------------------: |
| `CF_ACCOUNT_ID`   | Cloudflare è´¦æˆ· IDï¼ˆAccount Identifierï¼‰    | `a1b2c3d4e5f6g7h8i9j0`      |
| `CF_PROJECT_NAME` | Cloudflare Pages é¡¹ç›®åç§°ï¼ˆProject Nameï¼‰     | `my-pages-site`             |
| `CF_API_TOKEN`    | Cloudflare API Tokenï¼ˆç”¨äº Pages / API æ“ä½œï¼‰ | `cf_api_token_xxxxxxxxxxxx` |

`CF_API_TOKE` **åªéœ€** page çš„ç¼–è¾‘æƒé™å°±å¯ä»¥äº†

import { Spoiler } from 'astro-pure/user'

å¦‚æœä½ çš„å›½å†…ç«™ç‚¹ä¹Ÿæ˜¯é€šè¿‡ GitHub Actions æ¥æ„å»ºæ‹‰å–çš„è¯ï¼Œéœ€åœ¨ç›¸å…³å·¥ä½œæµæ–‡ä»¶åŠ å…¥å¯¹ `check-links.yml` å®ŒæˆçŠ¶æ€çš„æ£€æµ‹ <Spoiler>çº¯é™æ€ç«™ç‚¹å°±è¿™ç‚¹éº»çƒ¦ğŸ˜¡</Spoiler> <Spoiler>æˆ–è®¸æ˜¯æˆ‘ç»™å·¥ä½œå¤æ‚åŒ–äº†ğŸ¤”ï¼Ÿ</Spoiler>

```yml title="deploy.yml"
on: 
  workflow_run:
    workflows: ["ğŸ”— Friend Links Check"]
    types:
      - completed
```

<details>
<summary>å®Œæ•´ç‰ˆ `check-links.yml` æ–‡ä»¶</summary>
```yml title="check-links.yml"
name: ğŸ”— Friend Links Check

on:
  push:
    branches:
      - main
    paths:
      - 'public/links.json'
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:

jobs:
  check-links-and-update:
    name: Link Check & Upload
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
    
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
    
      - name: Install deps
        run: npm install p-limit tsx
    
      - name: Run link check
        run: npx tsx scripts/check-links.ts
    
      - name: Upload link.json to bucket
        run: |
          aws s3api put-object \
            --bucket ${{ secrets.BITIFUL_BUCKET_NAME }} \
            --key link.json \
            --body public/links.json \
            --endpoint-url https://${{ secrets.BITIFUL_S3_ENDPOINT }} \
            --region ${{ secrets.BITIFUL_REGION }}
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.BITIFUL_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.BITIFUL_SECRET_ACCESS_KEY }}

  trigger-pages-build:
    name: Trigger Cloudflare Pages build
    needs: check-links-and-update
    runs-on: ubuntu-latest

    if: ${{ needs.check-links-and-update.result == 'success' }}
    
    steps:
      - name: Update Cloudflare Pages
        run: |
            curl -X POST \
            "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CF_ACCOUNT_ID }}/pages/projects/${{ secrets.CF_PROJECT_NAME }}/deployments" \
            -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{}'
```
</details>

## å‰ç«¯æ¸²æŸ“

ç”±äºæ–°çš„ link.json æ–‡ä»¶æ”¾åœ¨äº†å­˜å‚¨æ¡¶é‡Œï¼Œå‹é“¾çš„æ•°æ®éœ€è¦æ”¹ä¸ºä»è¿œç«¯è¯»å–

éœ€ä¿®æ”¹ `src/components/links/FriendList.astro` æ–‡ä»¶å¦‚ä¸‹ï¼š
```astro titie="FriendList.astro"
---
//...

interface friend {
  avatar: string
  avatar_cache?: AvatarCache
  name: string
  intro: string
  link: string
  responseTime?: number // [!code ++]
}

//...

const { title, list: friendList, ...props } = Astro.props

let remoteData: Record<string, number> = {} // [!code ++:17]
try {
  const res = await fetch('your own bucket url')
  const json = await res.json()
  for (const group of json.friends) {
    for (const f of group.link_list) {
      remoteData[f.link] = f.responseTime
    }
  }
} catch (e) {
  console.warn('Failed to fetch remote link.json', e)
}

const enrichedLinkList = friendList.link_list.map((frd) => ({
  ...frd,
  responseTime: remoteData[frd.link] ?? frd.responseTime
}))

const getAvatarSrc = (friend: friend) =>
  (config.integ?.links?.cacheAvatar ?? false)
    ? (friend.avatar_cache?.path ?? friend.avatar)
    : friend.avatar
---
{title && <h2 id={friendList.id_name}>{title}</h2>}
<div class='grid gap-3.5 sm:grid-cols-2 sm:gap-4 lg:grid-cols-3' {...props}>
  {
    friendList.link_list.length > 0 ? (
      shuffle(friendList.link_list).map((frd: friend) => ( // [!code --]
      shuffle(enrichedLinkList).map((frd: friend) => ( // [!code ++]
        <a href={frd.link} target='_blank' class='no-underline'>
          <div class='group relative h-full overflow-hidden rounded-2xl border bg-background px-2.5 py-1.5 transition-colors hover:bg-muted sm:px-4 sm:py-2'>
            {frd.responseTime !== undefined && ( // [!code ++:15]
              <div class='absolute right-1.5 top-2 z-1 flex items-center gap-1 rounded-2xl bg-muted/50 px-1.5 py-0 text-[10px] leading-[1rem] text-muted-foreground backdrop-blur-sm transition-colors group-hover:bg-background/50 group-hover:text-foreground'>
                <div
                  class:list={[
                    'size-1.5 rounded-full',
                    frd.responseTime < 500
                      ? 'bg-green-400'
                      : frd.responseTime < 1500
                        ? 'bg-yellow-400'
                        : 'bg-red-400'
                  ]}
                />
                {frd.responseTime}ms
              </div>  
            )}
            <div class='relative z-10 flex h-full items-center gap-3'>
			  //...
            </div>
            {/* avatar bg */}
			  //...
          </div>
        </a>
      ))
    ) : (
      <p>Nothing here.</p>
    )
  }
</div>
```

## ä½¿ç”¨

åœ¨ GitHub Actions ä¸­æ‰¾åˆ° **ğŸ”— Friend Links Check** ï¼Œç‚¹å‡» `Run workflow` å¹¶è¿è¡Œï¼Œåç»­ä¼šåœ¨æ¯å¤©å›ºå®šæ—¶é—´è¿è¡Œï¼Œæˆ–è€… `links.json` æ›´æ–°æ—¶è‡ªåŠ¨è¿è¡Œâ¤ï¸
